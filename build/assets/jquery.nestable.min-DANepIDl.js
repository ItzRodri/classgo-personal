(function(a,h,d,N){function f(t,i){this.w=a(d),this.el=a(t),this.options=a.extend({},m,i),this.init()}var u="ontouchstart"in d,g=function(){var t=d.createElement("div"),i=d.documentElement;if(!("pointerEvents"in t.style))return!1;t.style.pointerEvents="auto",t.style.pointerEvents="x",i.appendChild(t);var o=h.getComputedStyle&&h.getComputedStyle(t,"").pointerEvents==="auto";return i.removeChild(t),!!o}(),m={listNodeName:"ol",itemNodeName:"li",rootClass:"dd",listClass:"dd-list",itemClass:"dd-item",dragClass:"dd-dragel",handleClass:"dd-handle",collapsedClass:"dd-collapsed",placeClass:"dd-placeholder",noDragClass:"dd-nodrag",emptyClass:"dd-empty",expandBtnHTML:'<button data-action="expand" type="button">Expand</button>',collapseBtnHTML:'<button data-action="collapse" type="button">Collapse</button>',group:0,maxDepth:5,threshold:20};f.prototype={init:function(){var t=this;t.reset(),t.el.data("nestable-group",this.options.group),t.placeEl=a('<div class="'+t.options.placeClass+'"/>'),a.each(this.el.find(t.options.itemNodeName),function(s,e){t.setParent(a(e))}),t.el.on("click","button",function(s){if(!t.dragEl){var e=a(s.currentTarget),n=e.data("action"),r=e.parent(t.options.itemNodeName);n==="collapse"&&t.collapseItem(r),n==="expand"&&t.expandItem(r)}});var i=function(s){var e=a(s.target);if(!e.hasClass(t.options.handleClass)){if(e.closest("."+t.options.noDragClass).length)return;e=e.closest("."+t.options.handleClass)}e.length&&!t.dragEl&&(t.isTouch=/^touch/.test(s.type),t.isTouch&&s.touches.length!==1||(s.preventDefault(),t.dragStart(s.touches?s.touches[0]:s)))},o=function(s){t.dragEl&&(s.preventDefault(),t.dragMove(s.touches?s.touches[0]:s))},l=function(s){t.dragEl&&(s.preventDefault(),t.dragStop(s.touches?s.touches[0]:s))};u&&(t.el[0].addEventListener("touchstart",i,!1),h.addEventListener("touchmove",o,!1),h.addEventListener("touchend",l,!1),h.addEventListener("touchcancel",l,!1)),t.el.on("mousedown",i),t.w.on("mousemove",o),t.w.on("mouseup",l)},serialize:function(){var t=this;return step=function(i,o){var l=[];return i.children(t.options.itemNodeName).each(function(){var s=a(this),e=a.extend({},s.data()),n=s.children(t.options.listNodeName);n.length&&(e.children=step(n,o+1)),l.push(e)}),l},step(t.el.find(t.options.listNodeName).first(),0)},serialise:function(){return this.serialize()},reset:function(){this.mouse={offsetX:0,offsetY:0,startX:0,startY:0,lastX:0,lastY:0,nowX:0,nowY:0,distX:0,distY:0,dirAx:0,dirX:0,dirY:0,lastDirX:0,lastDirY:0,distAxX:0,distAxY:0},this.isTouch=!1,this.moving=!1,this.dragEl=null,this.dragRootEl=null,this.dragDepth=0,this.hasNewRoot=!1,this.pointEl=null},expandItem:function(t){t.removeClass(this.options.collapsedClass),t.children('[data-action="expand"]').hide(),t.children('[data-action="collapse"]').show(),t.children(this.options.listNodeName).show()},collapseItem:function(t){t.children(this.options.listNodeName).length&&(t.addClass(this.options.collapsedClass),t.children('[data-action="collapse"]').hide(),t.children('[data-action="expand"]').show(),t.children(this.options.listNodeName).hide())},expandAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.expandItem(a(this))})},collapseAll:function(){var t=this;t.el.find(t.options.itemNodeName).each(function(){t.collapseItem(a(this))})},setParent:function(t){t.children(this.options.listNodeName).length&&(t.prepend(a(this.options.expandBtnHTML)),t.prepend(a(this.options.collapseBtnHTML))),t.children('[data-action="expand"]').hide()},unsetParent:function(t){t.removeClass(this.options.collapsedClass),t.children("[data-action]").remove(),t.children(this.options.listNodeName).remove()},dragStart:function(t){var i=this.mouse,o=a(t.target),l=o.closest(this.options.itemNodeName);this.placeEl.css("height",l.height()),i.offsetX=t.offsetX!==void 0?t.offsetX:t.pageX-o.offset().left,i.offsetY=t.offsetY!==void 0?t.offsetY:t.pageY-o.offset().top,i.startX=i.lastX=t.pageX,i.startY=i.lastY=t.pageY,this.dragRootEl=this.el,this.dragEl=a(d.createElement(this.options.listNodeName)).addClass(this.options.listClass+" "+this.options.dragClass),this.dragEl.css("width",l.width()),l.after(this.placeEl),l[0].parentNode.removeChild(l[0]),l.appendTo(this.dragEl),a(d.body).append(this.dragEl),this.dragEl.css({left:t.pageX-i.offsetX,top:t.pageY-i.offsetY});var s,e,n=this.dragEl.find(this.options.itemNodeName);for(s=0;s<n.length;s++)(e=a(n[s]).parents(this.options.listNodeName).length)>this.dragDepth&&(this.dragDepth=e)},dragStop:function(t){var i=this.dragEl.children(this.options.itemNodeName).first();i[0].parentNode.removeChild(i[0]),this.placeEl.replaceWith(i),this.dragEl.remove(),this.el.trigger("change"),this.hasNewRoot&&this.dragRootEl.trigger("change"),this.reset()},dragMove:function(t){var i,o,l,s=this.options,e=this.mouse;this.dragEl.css({left:t.pageX-e.offsetX,top:t.pageY-e.offsetY}),e.lastX=e.nowX,e.lastY=e.nowY,e.nowX=t.pageX,e.nowY=t.pageY,e.distX=e.nowX-e.lastX,e.distY=e.nowY-e.lastY,e.lastDirX=e.dirX,e.lastDirY=e.dirY,e.dirX=e.distX===0?0:e.distX>0?1:-1,e.dirY=e.distY===0?0:e.distY>0?1:-1;var n=Math.abs(e.distX)>Math.abs(e.distY)?1:0;if(!e.moving)return e.dirAx=n,void(e.moving=!0);e.dirAx!==n?(e.distAxX=0,e.distAxY=0):(e.distAxX+=Math.abs(e.distX),e.dirX!==0&&e.dirX!==e.lastDirX&&(e.distAxX=0),e.distAxY+=Math.abs(e.distY),e.dirY!==0&&e.dirY!==e.lastDirY&&(e.distAxY=0)),e.dirAx=n,e.dirAx&&e.distAxX>=s.threshold&&(e.distAxX=0,l=this.placeEl.prev(s.itemNodeName),e.distX>0&&l.length&&!l.hasClass(s.collapsedClass)&&(i=l.find(s.listNodeName).last(),this.placeEl.parents(s.listNodeName).length+this.dragDepth<=s.maxDepth&&(i.length?(i=l.children(s.listNodeName).last()).append(this.placeEl):((i=a("<"+s.listNodeName+"/>").addClass(s.listClass)).append(this.placeEl),l.append(i),this.setParent(l)))),e.distX<0&&(this.placeEl.next(s.itemNodeName).length||(o=this.placeEl.parent(),this.placeEl.closest(s.itemNodeName).after(this.placeEl),o.children().length||this.unsetParent(o.parent()))));var r=!1;if(g||(this.dragEl[0].style.visibility="hidden"),this.pointEl=a(d.elementFromPoint(t.pageX-d.body.scrollLeft,t.pageY-(h.pageYOffset||d.documentElement.scrollTop))),g||(this.dragEl[0].style.visibility="visible"),this.pointEl.hasClass(s.handleClass)&&(this.pointEl=this.pointEl.parent(s.itemNodeName)),this.pointEl.hasClass(s.emptyClass))r=!0;else if(!this.pointEl.length||!this.pointEl.hasClass(s.itemClass))return;var p=this.pointEl.closest("."+s.rootClass),c=this.dragRootEl.data("nestable-id")!==p.data("nestable-id");if(!e.dirAx||c||r){if(c&&s.group!==p.data("nestable-group")||this.dragDepth-1+this.pointEl.parents(s.listNodeName).length>s.maxDepth)return;var E=t.pageY<this.pointEl.offset().top+this.pointEl.height()/2;o=this.placeEl.parent(),r?((i=a(d.createElement(s.listNodeName)).addClass(s.listClass)).append(this.placeEl),this.pointEl.replaceWith(i)):E?this.pointEl.before(this.placeEl):this.pointEl.after(this.placeEl),o.children().length||this.unsetParent(o.parent()),this.dragRootEl.find(s.itemNodeName).length||this.dragRootEl.append('<div class="'+s.emptyClass+'"/>'),c&&(this.dragRootEl=p,this.hasNewRoot=this.el[0]!==this.dragRootEl[0])}}},a.fn.nestable=function(t){var i=this;return this.each(function(){var o=a(this).data("nestable");o?typeof t=="string"&&typeof o[t]=="function"&&(i=o[t]()):(a(this).data("nestable",new f(this,t)),a(this).data("nestable-id",new Date().getTime()))}),i||this}})(window.jQuery||window.Zepto,window,document);
